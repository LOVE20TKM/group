# 链群名称校验规则

## 概述

LOVE20 Group ID 系统中的链群名称需要严格校验，以保障安全性、一致性与良好的用户体验。本规则采取了**宽松但安全**的方案，支持国际化字符，同时避免滥用风险。

## 校验规则

### ✅ 允许

1. **长度**：1~64 字节（UTF-8 编码）

   - 注意：单个 Unicode 字符可能占用多个字节
   - 例子："群"（UTF-8 下占用 3 字节）

2. **字符类型**：

   - ✅ 字母：`a-z`，`A-Z`
   - ✅ 数字：`0-9`
   - ✅ 特殊符号：`-`、`_`、`.`、`@`、`!`、`#` 等
   - ✅ Unicode 字符：中文、日文、韩文、Emoji 等

3. **格式**：
   - ✅ 大小写混合
   - ✅ 混用特殊符号

### ❌ 拒绝

1. **空名称**

   - 报错：`GroupNameEmpty()`

2. **超过 64 字节的名称**

   - 报错：`InvalidGroupName()`

3. **空格字符 (0x20 及所有 Unicode 空格)**

   - 例子：" Group"、"Group "、"Group Name"、"Group 　 Name"（全角空格）
   - 报错：`InvalidGroupName()`
   - **包括但不限于：**
     - U+0020: 普通空格 (Space)
     - U+00A0: 不换行空格 (No-Break Space)
     - U+1680: Ogham 空格标记 (Ogham Space Mark)
     - U+2000-U+200A: 各种宽度的空格（En Quad, Em Quad, En Space, Em Space 等）
     - U+202F: 窄不换行空格 (Narrow No-Break Space)
     - U+205F: 中等数学空格 (Medium Mathematical Space)
     - U+3000: 中文全角空格 (Ideographic Space)

4. **控制字符 (0x00-0x1F)**

   - 包含：换行符(`\n`)、制表符(`\t`)、回车符(`\r`) 等
   - 报错：`InvalidGroupName()`

5. **DEL 字符 (0x7F)**

   - 报错：`InvalidGroupName()`

6. **零宽字符（Zero-Width Characters）**
   - 零宽空格 (U+200B)
   - 零宽非连接符 (U+200C)
   - 零宽连接符 (U+200D)
   - 左到右标记 (U+200E)
   - 右到左标记 (U+200F)
   - 组合用字形连接符 (U+034F)
   - 零宽不换行空格/BOM (U+FEFF)
   - 词连接符 (U+2060)
   - 软连字符 (U+00AD)
   - 报错：`InvalidGroupName()`
   - **说明**：这些不可见字符常被用于混淆和欺骗攻击，因此被完全禁止

## 示例

### 合法链群名称示例 ✅

```solidity
"MyGroup"                  // 简单 ASCII
"Group-123"                // 含数字与短横线
"My_Group.v2"              // 多种特殊符号
"链群名称"                 // 中文
"Group链群"                // 中英文混合
"🎉PartyGroup"             // Emoji 表情
"Group@Company"            // 含 @ 符号
"a"                        // 单字符
"1234567890123456789012345678901234567890123456789012345678901234" // 64 字节（最大）
```

### 非法链群名称示例 ❌

```solidity
""                       // 空字符串 (GroupNameEmpty)
" Group"                 // 首部空格 (InvalidGroupName)
"Group "                 // 尾部空格 (InvalidGroupName)
"Group Name"             // 内部 ASCII 空格 (InvalidGroupName)
"Group　Name"            // 中文全角空格 U+3000 (InvalidGroupName)
"Group\u00A0Name"        // 不换行空格 (InvalidGroupName)
"Group\u2003Name"        // Em Space (InvalidGroupName)
"Group\nName"            // 换行符 (InvalidGroupName)
"Group\tName"            // 制表符 (InvalidGroupName)
"Group\u200BName"        // 零宽空格 (InvalidGroupName)
"Group\u200CName"        // 零宽非连接符 (InvalidGroupName)
"Group\u034FName"        // 组合用字形连接符 (InvalidGroupName)
"Group\u00ADName"        // 软连字符 (InvalidGroupName)
"\uFEFFGroupName"        // BOM字符 (InvalidGroupName)
"12345678901234567890123456789012345678901234567890123456789012345" // 65 字节 (InvalidGroupName)
```

## 技术说明

### 字节长度与字符数的区别

64 字节上限指的是**UTF-8 编码下的字节数**，并非字符数量。即：

- 英文/数字/常见符号：每个 1 字节，可用 64 个字符
- 中文/日文/韩文等 CJK 字符：通常每个 3 字节，约 21 个字符
- Emoji 表情：通常每个 4 字节，约 16 个字符
- 混合内容：可用字符数根据组合而变化

### 实现说明

实际校验由合约内部 `_isValidGroupName()` 函数实现，其步骤包括：

1. 校验字节长度为 1~64
2. 遍历字节过滤 C0 控制字符 (0x00-0x1F) 和 ASCII 空格 (0x20)
3. 拒绝 DEL 字符 (0x7F)
4. 检测并拒绝所有 Unicode 空格字符（U+00A0、U+1680、U+2000-U+200A、U+202F、U+205F、U+3000）
5. 检测并拒绝零宽字符（通过匹配特定的 UTF-8 字节序列）
6. 允许所有其它字符（包括多字节 Unicode）

## 安全注意事项

### 规则设计初衷

1. **拒绝控制字符**：防止注入攻击及显示问题
2. **禁止所有空格**：包括 ASCII 空格和所有 Unicode 空格字符，避免混淆、欺骗与输入错误
3. **限制长度**：减少 GAS 消耗与存储负担
4. **拒绝零宽字符**：防止不可见字符造成的混淆和欺骗攻击
5. **UTF-8 国际化支持**：为全球用户提供原生命名体验

### 空格字符防护

系统已实现对所有常见 Unicode 空格字符的检测和拒绝：

| Unicode | 名称               | UTF-8 编码     | 说明               |
| ------- | ------------------ | -------------- | ------------------ |
| U+0020  | 普通空格           | 0x20           | ASCII 空格         |
| U+00A0  | 不换行空格         | 0xC2 0xA0      | No-Break Space     |
| U+1680  | Ogham 空格标记     | 0xE1 0x9A 0x80 | Ogham Space Mark   |
| U+2000  | En Quad            | 0xE2 0x80 0x80 | En Quad            |
| U+2001  | Em Quad            | 0xE2 0x80 0x81 | Em Quad            |
| U+2002  | En Space           | 0xE2 0x80 0x82 | En Space           |
| U+2003  | Em Space           | 0xE2 0x80 0x83 | Em Space           |
| U+2004  | Three-Per-Em Space | 0xE2 0x80 0x84 | Three-Per-Em Space |
| U+2005  | Four-Per-Em Space  | 0xE2 0x80 0x85 | Four-Per-Em Space  |
| U+2006  | Six-Per-Em Space   | 0xE2 0x80 0x86 | Six-Per-Em Space   |
| U+2007  | Figure Space       | 0xE2 0x80 0x87 | Figure Space       |
| U+2008  | Punctuation Space  | 0xE2 0x80 0x88 | Punctuation Space  |
| U+2009  | Thin Space         | 0xE2 0x80 0x89 | Thin Space         |
| U+200A  | Hair Space         | 0xE2 0x80 0x8A | Hair Space         |
| U+202F  | 窄不换行空格       | 0xE2 0x80 0xAF | Narrow No-Break    |
| U+205F  | 中等数学空格       | 0xE2 0x81 0x9F | Medium Math Space  |
| U+3000  | 中文全角空格       | 0xE3 0x80 0x80 | Ideographic Space  |

**防护原理**：通过在字节级别检测这些字符的 UTF-8 编码序列，可有效防止：

- 视觉相同但实际不同的名称欺骗（如使用不同空格字符）
- 隐藏字符导致的安全漏洞
- 前端显示不一致的问题
- 用户误输入全角空格等不易察觉的字符

### 零宽字符防护

系统已实现对以下零宽字符的检测和拒绝：

| Unicode | 名称               | UTF-8 编码     |
| ------- | ------------------ | -------------- |
| U+200B  | 零宽空格           | 0xE2 0x80 0x8B |
| U+200C  | 零宽非连接符       | 0xE2 0x80 0x8C |
| U+200D  | 零宽连接符         | 0xE2 0x80 0x8D |
| U+200E  | 左到右标记         | 0xE2 0x80 0x8E |
| U+200F  | 右到左标记         | 0xE2 0x80 0x8F |
| U+034F  | 组合用字形连接符   | 0xCD 0x8F      |
| U+FEFF  | BOM/零宽不换行空格 | 0xEF 0xBB 0xBF |
| U+2060  | 词连接符           | 0xE2 0x81 0xA0 |
| U+00AD  | 软连字符           | 0xC2 0xAD      |

**防护原理**：通过在字节级别检测这些字符的 UTF-8 编码序列，可有效防止：

- 视觉相同但实际不同的名称欺骗
- 隐藏字符导致的安全漏洞
- 前端显示不一致的问题

### 潜在边缘情况

1. **右到左（RTL）字符**：允许使用，但显示可能造成困扰

   - 前端应妥善处理 RTL 文字方向
   - 注意：RTL 标记符（U+200E/U+200F）已被禁止

2. **同形异义攻击（Homograph）**：有些脚本下字符极为相似
   - 例："A"（拉丁）与 "А"（西里尔）
   - 例："0"（数字零）与 "O"（字母 O）
   - 建议应用层增加前端提示与风险提醒

## 集成方最佳实践

### 前端校验范例

合约调用前建议先在前端做一次校验：

```javascript
function isValidGroupName(name) {
  // 校验字节长度（UTF-8 编码）
  const bytes = new TextEncoder().encode(name);
  if (bytes.length === 0 || bytes.length > 64) return false;

  // 校验 ASCII 空格和控制字符
  if (/[\x00-\x20\x7F]/.test(name)) return false;

  // 校验所有 Unicode 空格字符
  const unicodeSpaces = /[\u00A0\u1680\u2000-\u200A\u202F\u205F\u3000]/;
  if (unicodeSpaces.test(name)) return false;

  // 校验零宽字符
  const zeroWidthChars = /[\u200B-\u200F\uFEFF\u2060\u00AD\u034F]/;
  if (zeroWidthChars.test(name)) return false;

  return true;
}
```

### 用户体验建议

1. **实时校验**：输入时就给出反馈
2. **字节计数提示**：显示已用/剩余字节（如 "15/64 字节"）
3. **详细报错信息**：引导用户修正
4. **展示有效/无效案例**：帮助理解规则

## 合约错误提示

| 异常                       | 触发原因                                     |
| -------------------------- | -------------------------------------------- |
| `GroupNameEmpty()`         | 名称为空字符串                               |
| `InvalidGroupName()`       | 名称不符合校验规则（长度、空格、控制字符等） |
| `GroupNameAlreadyExists()` | 链群名称已被注册（区分大小写）               |

## 版本历史

- **v1.0.0**（当前）：初始实现，支持 UTF-8 校验及基础规则
  - 新增：支持 UTF-8 字符校验
  - 新增：64 字节长度上限
  - 新增：首尾空格过滤
  - 新增：控制字符过滤
